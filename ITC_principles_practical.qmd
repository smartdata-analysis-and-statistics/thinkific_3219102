---
title: "Principles of Indirect Treatment Comparisons"
author: "Thomas Debray"
format:
  html:
    toc: true
    number-sections: false
execute:
  echo: false
  message: false
  warning: false
---

```{r}
#| echo: false
#| message: false
library(knitr)
```

This exercise helps you familiarize yourself with the principles of indirect and mixed treatment comparisons.  
You’ll use a simple, real-data-inspired example involving **Semaglutide**, **Liraglutide**, and **Placebo**, and visualize the treatment network using the `multinma` package in R.

Although the data have been slightly simplified for illustration, the reported treatment effects are based on estimates published in [*Nature Medicine* (2025)](https://www.nature.com/articles/s41591-025-03978-z) 

## Background

In this example, two clinical trials each compared an active treatment with **Placebo**.  We’d like to understand how **Semaglutide** performs relative to **Liraglutide**, even though no head-to-head trial was conducted.  We derived the following **contrast-level data** from the published trials:


| Comparison             | Effect Size | Error Variance | 95% CI (approx.)     |
|-------------------------|-------------|----------------|----------------------|
| Liraglutide vs Placebo  | 4.53        | 0.26           | (3.56, 5.55)         |
| Semaglutide vs Placebo  | 10.02       | 1.78           | (7.40, 12.63)        |

Each effect size represents the mean percentage difference in total body weight loss versus placebo. 

These effect sizes were derived from studies summarized in the Nature Medicine paper cited above.  We’ll now use them to estimate the **indirect comparison** between the two active drugs.

## Step 1. Visualizing the Treatment Network
Let’s visualize how these two studies form a (simple) network of interventions.

```{r}
#| message: false
# install.packages("multinma")  # if not already installed
library(multinma)
library(tibble)

# Define contrast-level data
agd_contrast <- tribble(
  ~studyn,    ~trtn,           ~diff,    ~se_diff,
  "Study 1", "Placebo",    NA, NA,
  "Study 1", "Liraglutide",    4.53, sqrt(0.26),
  "Study 2", "Placebo",   NA, NA,
  "Study 2", "Semaglutide",   10.02, sqrt(1.78)
)

net <- set_agd_contrast(agd_contrast,
                 study = studyn,
                 trt = trtn,
                 y = diff,
                 se = se_diff)

# Visualize
plot(net, weight_edges = TRUE, weight_nodes = FALSE)
```

## Step 2. Estimating the Indirect Comparison

When two treatments have both been compared to a common control, we can use the **consistency equation** to indirectly compare them:

$\hat{\Delta}_{A,B} = \hat{\Delta}_{A,C} - \hat{\Delta}_{B,C}$

$\text{Var}(\hat{\Delta}_{A,B}) = \text{Var}_{A,C} + \text{Var}_{B,C}$

Try it yourself:

```{r}
# Effect sizes and variances (based on Nature Medicine 2025 study)
lira <- list(est = 4.53, var = 0.26)
sema <- list(est = 10.02, var = 1.78)

# Indirect comparison: Semaglutide vs Liraglutide
est_indirect <- sema$est - lira$est
var_indirect <- sema$var + lira$var
se_indirect  <- sqrt(var_indirect)

# 95% Confidence Interval
ci <- est_indirect + qnorm(c(0.025, 0.975)) * se_indirect
```

You should obtain approximately:

```{r}
#| echo: false
df <- data.frame(
  Comparison = "Semaglutide vs Liraglutide (indirect)",
  EffectSize = est_indirect,
  SE = se_indirect,
  CI_lower = ci[1],
  CI_upper = ci[2]
)
kable(df)
```

This means that, based on indirect evidence through placebo, Semaglutide achieves about `r format(est_indirect, digits = 1)`% greater mean weight loss than Liraglutide.
