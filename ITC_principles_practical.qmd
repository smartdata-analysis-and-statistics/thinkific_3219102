---
title: "Principles of Indirect Treatment Comparisons"
author: "Thomas Debray"
format:
  html:
    toc: true
    number-sections: true
execute:
  message: false
  warning: false
---

```{r}
#| echo: false
#| message: false
library(dplyr)
library(knitr)
library(kableExtra)
```

# Getting Started

## About this Practical

This practical is designed for R, an open-source statistical programming environment widely used for data analysis and evidence synthesis. All examples can be reproduced on any computer with R (≥ `r paste0(R.Version()$major, ".", R.Version()$minor)`) and the following packages installed: `multinma`, `dplyr`, and `tibble`.

If you are new to R:

*	Download and install R from https://cran.r-project.org.
*	(Optional) Install RStudio for an easier coding interface: https://posit.co/download/rstudio/.
*	You can install all required packages with:
	
```{r}
#| eval: false
install.packages(c("multinma", "dplyr", "tibble"))
```

If running this practical on a shared or institutional computer, ensure these packages are available before starting.
No special configuration or external data files are needed.

## Introduction
This exercise helps you familiarize yourself with the principles of indirect and mixed treatment comparisons.  
You’ll use a simple, real-data-inspired example involving **Semaglutide**, **Liraglutide**, and **Placebo**, and visualize the treatment network using the `multinma` package in R.

Although the data have been slightly simplified for illustration, the reported treatment effects are based on estimates published in [*Nature Medicine* (2025)](https://www.nature.com/articles/s41591-025-03978-z) 


## Background

In this example, two clinical trials each compared an active treatment with **Placebo**.  We’d like to understand how **Semaglutide** performs relative to **Liraglutide**, even though no head-to-head trial was conducted.  We derived the following **contrast-level data** from the published trials:


| Comparison             | Effect Size | Error Variance | 95% CI     |
|-------------------------|-------------|----------------|----------------------|
| Liraglutide vs Placebo  | 4.53        | 0.26           | (3.56; 5.55)         |
| Semaglutide vs Placebo  | 10.02       | 1.78           | (7.40; 12.63)        |

Each effect size represents the mean percentage difference in total body weight loss versus placebo. 

These effect sizes were derived from studies summarized in the Nature Medicine paper cited above.  We’ll now use them to estimate the **indirect comparison** between the two active drugs.

# Hands-on Analysis

## Step 1. Visualizing the Treatment Network
Let’s visualize how these two studies form a (simple) network of interventions.

```{r}
#| message: false
library(multinma)
library(tibble)

# Contrast-level AgD with a reference row per study (y = NA on Placebo)
agd_contrast <- tribble(
  ~studyn,   ~trtn,         ~diff,        ~se_diff,
  "Study 1", "Placebo",        NA_real_,       NA_real_,
  "Study 1", "Liraglutide",     4.53,      sqrt(0.26),
  "Study 2", "Placebo",        NA_real_,       NA_real_,
  "Study 2", "Semaglutide",    10.02,     sqrt(1.78)
)

net <- set_agd_contrast(agd_contrast,
                 study = studyn,
                 trt = trtn,
                 y = diff,
                 se = se_diff)

# Visualize
plot(net, weight_edges = TRUE, weight_nodes = FALSE)
```
In this network plot, we can see

* Placebo is the common comparator
* Liraglutide and Semaglutide are connected through Placebo

## Step 2. Estimating the Indirect Comparison

When two treatments have both been compared to a common control, we can use the **consistency equation** to indirectly compare them:

$\hat{\Delta}_{A,B} = \hat{\Delta}_{A,C} - \hat{\Delta}_{B,C}$

$\text{Var}(\hat{\Delta}_{A,B}) = \text{Var}_{A,C} + \text{Var}_{B,C}$

Try it yourself:

```{r}
# Effect sizes and variances (based on Nature Medicine 2025 study)
lira <- list(est = 4.53, var = 0.26)
sema <- list(est = 10.02, var = 1.78)

# Indirect comparison: Semaglutide vs Liraglutide
est_indirect <- sema$est - lira$est
var_indirect <- sema$var + lira$var
se_indirect  <- sqrt(var_indirect)

# 95% Confidence Interval
ci <- est_indirect + qnorm(c(0.025, 0.975)) * se_indirect
```

You should obtain an effect size of approximately `r est_indirect` in favor of Semaglutide, with a 95% confidence interval of (`r format(ci[1], digits = 2, nsmall = 2)`, `r format(ci[2], digits = 2, nsmall = 2)`). This means that, based on indirect evidence through placebo, Semaglutide achieves about `r format(est_indirect, digits = 2, nsmall = 2)`% greater mean weight loss than Liraglutide.

We can fit the same analysis using the `multinma` package, which adopts a Bayesian estimation framework:

```{r}
#| message: false
#| warning: false
#| eval: false
db_fit_FE <- nma(net, 
                 trt_effects = "fixed",
                 link = "identity")
relative_effects(db_fit_FE, trt_ref = "Liraglutide")
```

```{r}
#| message: false
#| warning: false
#| echo: false
db_fit_FE <- nma(net, 
                 trt_effects = "fixed",
                 link = "identity", 
                 refresh = 0)
rel_sum <- relative_effects(db_fit_FE, trt_ref = "Liraglutide")
rel_tab <- rel_sum$summary %>%
    as.data.frame() %>%
    tibble::rownames_to_column("contrast")

rel_tab %>%
    mutate(
        contrast = paste0(.trtb, " vs. ", .trta)  # merge treatment names
    ) %>%
    select(contrast, mean, sd, `2.5%`, `50%`, `97.5%`) %>%
    mutate(
        across(c(mean, sd, `2.5%`, `50%`, `97.5%`), ~ sprintf("%.2f", .x))
    ) %>%
    kable(
        format = "html",
        col.names = c("Contrast", "Mean", "SD", "2.5%", "Median", "97.5%"),
        align = c("l", rep("r", 5))
    ) %>%
    kable_styling(
        full_width = FALSE,
        bootstrap_options = c("striped", "hover", "condensed"),
        position = "center"
    ) %>%
    add_header_above(c(" " = 1, "Posterior Summary" = 5))
```



## Step 3. Mixed Treatment Comparisons

Now that you have seen how two studies connect through a common comparator, we can extend the idea of an indirect comparison to a mixed treatment comparison (MTC).

An MTC combines both **direct** and **indirect** evidence across a connected network of trials.  
- *Direct evidence* comes from head-to-head trials comparing two treatments in the same study.  
- *Indirect evidence* arises when two treatments are compared through a shared control (e.g., Placebo).  

By "mixing" these sources, we obtain more precise estimates of relative effects across all treatments.

Consider we now have a third study that directly compares **Semaglutide** and **Liraglutide**:

| Comparison                  | Effect Size | Error Variance | 95% CI               |
|-----------------------------|-------------|----------------|----------------------|
| Liraglutide vs Placebo      | 4.53        | 0.26           | (3.56; 5.55)         |
| Semaglutide vs Placebo      | 10.02       | 1.78           | (7.40; 12.63)        |
| Semaglutide vs Liraglutide  | 9.40        | 1.65           | (6.88; 11.91)        |

We can update our contrast-level data to include this new direct comparison:

$\hat{\Delta}_{A,B, \text{mixed}} = \left(\frac{\hat{\Delta}_{A,B, \text{direct}}}{\text{Var}(\hat{\Delta}_{A,B, \text{direct}})} + \frac{\hat{\Delta}_{A,B, \text{indirect}}}{\text{Var}(\hat{\Delta}_{A,B, \text{indirect}})}\right)  \left(\frac{1}{\text{Var}(\hat{\Delta}_{A,B, \text{direct}})} + \frac{1}{\text{Var}(\hat{\Delta}_{A,B, \text{indirect}})}\right)^{-1}$

$\text{Var}(\hat{\Delta}_{A,B, \text{mixed}}) =  \left(\frac{1}{\text{Var}(\hat{\Delta}_{A,B, \text{direct}})} + \frac{1}{\text{Var}(\hat{\Delta}_{A,B, \text{indirect}})}\right)^{-1}$

In R, we can derive the mixed effect as follows:

```{r}
# New direct comparison data
direct_comp <- list(est = 9.40, var = 1.65)

# Mixed treatment comparison
est_mixed <- (direct_comp$est / direct_comp$var + est_indirect / var_indirect) /
               (1 / direct_comp$var + 1 / var_indirect)
var_mixed <- 1 / (1 / direct_comp$var + 1 / var_indirect)
se_mixed <- sqrt(var_mixed)

# 95% Confidence Interval
ci_mixed <- est_mixed + qnorm(c(0.025, 0.975)) * se_mixed
```

You should obtain an effect size of approximately `r format(est_mixed, digits = 2, nsmall = 2)` in favor of Semaglutide, with a 95% confidence interval of (`r format(ci_mixed[1], digits = 2, nsmall = 2)`; `r format(ci_mixed[2], digits = 2, nsmall = 2)`). 

We can fit the same analysis using the `multinma` package:

```{r}
#| message: false
#| warning: false
# Updated contrast-level AgD including direct comparison
agd_contrast <- tribble(
  ~studyn,   ~trtn,         ~diff,        ~se_diff,
  "Study 1", "Placebo",        NA_real_,       NA_real_,
  "Study 1", "Liraglutide",     4.53,      sqrt(0.26),
  "Study 2", "Placebo",        NA_real_,       NA_real_,
  "Study 2", "Semaglutide",    10.02,     sqrt(1.78),
  "Study 3", "Liraglutide",     NA_real_,       NA_real_,
  "Study 3", "Semaglutide",     9.40,      sqrt(1.65)
)

net <- set_agd_contrast(agd_contrast,
                 study = studyn,
                 trt = trtn,
                 y = diff,
                 se = se_diff)
```


```{r}
#| message: false
#| warning: false
#| eval: false
db_fit_FE_mixed <- nma(net, 
                       trt_effects = "fixed",
                       link = "identity")
relative_effects(db_fit_FE_mixed, trt_ref = "Liraglutide")
```

```{r}
#| message: false
#| warning: false
#| echo: false
db_fit_FE_mixed <- nma(net, 
                 trt_effects = "fixed",
                 link = "identity", 
                 refresh = 0)
rel_sum <- relative_effects(db_fit_FE_mixed, trt_ref = "Liraglutide")
rel_tab <- rel_sum$summary %>%
    as.data.frame() %>%
    tibble::rownames_to_column("contrast")

rel_tab %>%
    mutate(
        contrast = paste0(.trtb, " vs. ", .trta)  # merge treatment names
    ) %>%
    select(contrast, mean, sd, `2.5%`, `50%`, `97.5%`) %>%
    mutate(
        across(c(mean, sd, `2.5%`, `50%`, `97.5%`), ~ sprintf("%.2f", .x))
    ) %>%
    kable(
        format = "html",
        col.names = c("Contrast", "Mean", "SD", "2.5%", "Median", "97.5%"),
        align = c("l", rep("r", 5))
    ) %>%
    kable_styling(
        full_width = FALSE,
        bootstrap_options = c("striped", "hover", "condensed"),
        position = "center"
    ) %>%
    add_header_above(c(" " = 1, "Posterior Summary" = 5))
```

We can also rank the treatments included in this example according to their estimated effectiveness:

```{r}
#| message: false
#| warning: false
db_rankprobs <- posterior_rank_probs(db_fit_FE_mixed, lower_better = FALSE)
plot(db_rankprobs)
```

In this figure, we can see that Semaglutide has the highest probability of being the most effective treatment for weight loss, followed by Liraglutide and Placebo. These rankings apply only to the subset of treatments analyzed in this simplified example, not to the full network of interventions reported in the Nature Medicine publication.


# Going Further

## Extending Network Meta-analysis
This section is under development. Please check back later for an applied example.


# Session information

```{r}
#| echo: false
#| message: false
#| warning: false
library(sessioninfo)
sessioninfo::session_info()
```
