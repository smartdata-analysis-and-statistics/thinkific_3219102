---
title: "Comparative Effectiveness of Treatments for COPD: A Network Meta-Analysis Example"
author: "Thomas Debray"
format:
  html:
    toc: true
    number-sections: true
execute:
  message: false
  warning: false
bibliography: 'bibliography.bib'
---


## Overview
This vignette reproduces the main analyses discussed in the book chapter "Principles of meta-analysis and indirect treatment comparisons" [@debray_principles_2025].

Here, we focus on a case study evaluating the comparative effectiveness of maintenance inhaled therapies for chronic obstructive pulmonary disease (COPD).

The example is based on the systematic review by Baker et al. [@baker_pharmacologic_2009], which identified 39 randomized controlled trials including 28,232 patients. These trials compared long-acting β₂-agonists (LABAs), tiotropium (TIO), inhaled corticosteroids (ICS), and combination ICS–LABA therapies with respect to exacerbation risk. The corresponding treatment network contains multiple closed loops, enabling both direct and indirect treatment comparisons. Unlike the COVID-19 example, this network provides an opportunity to assess local inconsistency across overlapping comparisons and to explore sources of heterogeneity and bias within a richer evidence structure.

## Data Source

Trials were identified through a systematic literature search of the following databases: MEDLINE (1950 -- October 2007), EMBASE (1990 -- October 2007), CINAHL (1982 -- October 2007), the Cochrane Central Register of Controlled Trials (third quarter 2007), as well as Web of Science (1994 -- October 2007).

Inclusion criteria were:

* Randomized and controlled design (placebo or active comparator).
* Study population consisting of patients with chronic obstructive pulmonary disease (COPD).
* Evaluation of at least one of the following COPD drug classes:
  * Inhaled corticosteroids (ICS)
  * Tiotropium (TIO)
  * Long-acting β₂-agonists (LABAs)
  * Combination ICS–LABA therapy
* Reporting of outcomes related to COPD exacerbation frequency or mortality.
	
Data are available from the R package `netmeta`:

```{r}
#| message: false
library(netmeta)
data(Baker2009)
```

```{r}
#| echo: false
library(kableExtra)
kable(head(Baker2009))
```

The primary outcome was the occurrence of one or more episodes of COPD exacerbation, recorded as a binary variable (yes/no).
The network compares five single-agent treatments—fluticasone, budesonide, salmeterol, formoterol, and tiotropium—and two combination therapies (fluticasone + salmeterol and budesonide + formoterol) against placebo.
Importantly, the original authors treated the combination therapies as distinct interventions rather than decomposing them into their individual components.


## Setting up the Network
In this vignette we will implement a frequentist NMA using the `netmeta` package. We first convert the arm-level data to contrast-level data using the `pairwise` function:

```{r}
#| echo: true
#| message: false
#| warning: false
Baker <- pairwise(treat = treatment,
                  event = exac,
                  n = total,
                  studlab = id,
                  sm = "OR",
                  data = Baker2009)
```

In he resulting data frame `Baker`, each row corresponds to a direct comparison between two treatments within a trial, with columns for the treatment names (`treat1`, `treat2`), the log-odds ratio (`TE`), its standard error (`seTE`), and the study label (`studlab`).

## Random-Effects Network Meta-Analysis

We subsequently fit a random-effects model using the `netmeta` function, specifying "Placebo" as the reference treatment:

```{r}
#| echo: true
#| message: false
#| warning: false
NMA.COPD <- netmeta(TE = TE, seTE = seTE, treat1 = treat1, treat2 = treat2,
                    studlab = studlab, data = Baker, sm = "OR", ref = "Placebo",
                    random = TRUE)

netgraph(NMA.COPD)
```

## Assessing Network Inconsistency
We can test for local network inconsistency as follows:

```{r}
#| eval: false
netsplit(NMA.COPD)
```

By default, indirect estimates are derived using the back-calculation method. A comparison of direct and indirect treatment effect estimates (depicted as odds ratio) from the random effects network meta-analysis model is given in the table below:

```{r}
#| echo: false
library(dplyr)
SIDES.COPD <- netsplit(NMA.COPD)
out <- data.frame("comparison" = SIDES.COPD$comparison,
                  "k" = SIDES.COPD$k,
             "nma" = sprintf("%.2f",exp(SIDES.COPD$random$TE)), 
             "direct" = sprintf("%.2f",exp(SIDES.COPD$direct.random$TE)), 
             "indirect" = sprintf("%.2f",exp(SIDES.COPD$indirect.random$TE)),  
             "RoR" = sprintf("%.2f",exp(SIDES.COPD$compare.random$TE)),
             "p.RoR" = sprintf("%.2f",SIDES.COPD$compare.random$p))

# Replacing all NA values with "."
out <- out %>% 
  mutate(across(everything(), ~ifelse(.=="NA", ".", .)))

out %>% 
  kable(
      align = "lcccccc",
      booktabs = TRUE,
      longtable = TRUE,
      linesep = ""
    ) %>%
    kableExtra::kable_styling(
      latex_options = c("repeat_header"),
    )
```

We can compare both models as follows:

```{r}
#| echo: true
#| message: false
#| warning: false
NMA.UME <- netmeta(TE = TE, seTE = seTE, treat1 = treat1, treat2 = treat2,
                    studlab = studlab, data = Baker, sm = "OR", ref = "Placebo",
                    random = TRUE, UME = TRUE)
# Extract tau
tau_RE <- NMA.COPD$tau
tau_UME <- 
```
